<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Eye Health Analysis - BlinkWell</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            height: 8px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #10b981, #059669);
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 25px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
            color: white;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }

        .step.active {
            background: rgba(255, 255, 255, 0.3);
            font-weight: 600;
        }

        .step.completed {
            background: rgba(16, 185, 129, 0.3);
        }

        .analysis-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 25px;
            text-align: center;
            color: white;
        }

        .card-content {
            padding: 40px;
        }

        /* Image Upload Styles */
        .upload-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #5a67d8;
            background: #f0f2ff;
        }

        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #999;
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .preview-container {
            display: none;
            margin-top: 20px;
            text-align: center;
        }

        .preview-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        /* Questionnaire Styles */
        .questionnaire-section {
            display: none;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .radio-option input[type="radio"] {
            width: auto;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e1e5e9;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
        }

        /* Button Styles */
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #e1e5e9;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            color: #333;
        }

        /* Results Styles */
        .results-section {
            display: none;
            margin-top: 40px;
        }

        .result-summary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .risk-level {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .risk-level.very-high { color: #fee2e2; }
        .risk-level.high { color: #fef3c7; }
        .risk-level.moderate { color: #fef3c7; }
        .risk-level.low { color: #d1fae5; }
        .risk-level.very-low { color: #d1fae5; }

        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .analysis-item {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .analysis-item h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .probability-bar {
            width: 100%;
            height: 12px;
            background: #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
            margin: 10px 0;
        }

        .probability-fill {
            height: 100%;
            transition: width 0.5s ease;
        }

        .probability-fill.high {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .probability-fill.medium {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .probability-fill.low {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .recommendations-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .recommendations-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
        }

        .recommendations-content {
            padding: 30px;
        }

        .recommendation-category {
            margin-bottom: 30px;
        }

        .recommendation-category h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .recommendation-list {
            list-style: none;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .recommendation-icon {
            width: 35px;
            height: 35px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
            font-size: 0.9rem;
        }

        .risk-factors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .risk-factor-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .risk-factor-item.high {
            border-left-color: #ef4444;
        }

        .risk-factor-item.medium {
            border-left-color: #f59e0b;
        }

        .risk-factor-item.low {
            border-left-color: #10b981;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .message.error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .message.success {
            background: #d1fae5;
            color: #059669;
            border: 1px solid #a7f3d0;
        }

        .message.info {
            background: #dbeafe;
            color: #1d4ed8;
            border: 1px solid #93c5fd;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .card-content {
                padding: 25px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .step-indicator {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-eye"></i> Comprehensive Eye Health Analysis</h1>
            <p>Complete AI-powered eye health assessment combining image analysis and health questionnaire</p>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 33%"></div>
            </div>
            
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <i class="fas fa-camera"></i>
                    <span>Image Analysis</span>
                </div>
                <div class="step" id="step2">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Health Questionnaire</span>
                </div>
                <div class="step" id="step3">
                    <i class="fas fa-chart-line"></i>
                    <span>Comprehensive Results</span>
                </div>
            </div>
        </div>

        <!-- Step 1: Image Analysis -->
        <div class="analysis-card" id="imageAnalysisCard">
            <div class="card-header">
                <h3>Step 1: Eye Image Analysis</h3>
                <p>Upload a clear photo of your eye for initial AI analysis</p>
            </div>

            <div class="card-content">
                <div class="upload-section">
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">Click to upload or drag and drop</div>
                        <div class="upload-subtext">PNG, JPG, JPEG files only (Max 5MB)</div>
                    </div>
                    
                    <input type="file" id="fileInput" class="file-input" accept="image/*">
                    
                    <div class="preview-container" id="previewContainer">
                        <img id="previewImage" class="preview-image" alt="Preview">
                        <br>
                        <button id="analyzeBtn" class="btn btn-primary" onclick="analyzeImage()">
                            <i class="fas fa-search"></i>
                            Analyze Image
                        </button>
                    </div>
                </div>

                <div class="message" id="imageMessage"></div>

                <div id="imageResult" style="display: none;">
                    <div class="analysis-item">
                        <h3><i class="fas fa-eye"></i> Image Analysis Result</h3>
                        <p id="imageResultText"></p>
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn btn-primary" onclick="proceedToQuestionnaire()">
                                <i class="fas fa-arrow-right"></i>
                                Continue to Questionnaire
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Health Questionnaire -->
        <div class="analysis-card questionnaire-section" id="questionnaireCard">
            <div class="card-header">
                <h3>Step 2: Health & Lifestyle Questionnaire</h3>
                <p>Complete this comprehensive questionnaire for detailed analysis</p>
            </div>

            <div class="card-content">
                <form id="questionnaireForm">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <h3><i class="fas fa-user"></i> Basic Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="gender">Gender</label>
                                <select id="gender" name="Gender" required>
                                    <option value="">Select Gender</option>
                                    <option value="M">Male</option>
                                    <option value="F">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="age">Age</label>
                                <input type="number" id="age" name="Age" min="1" max="100" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="height">Height (cm)</label>
                                <input type="number" id="height" name="Height" min="100" max="250" required>
                            </div>
                            <div class="form-group">
                                <label for="weight">Weight (kg)</label>
                                <input type="number" id="weight" name="Weight" min="30" max="200" required>
                            </div>
                        </div>
                    </div>

                    <!-- Sleep Information -->
                    <div class="form-section">
                        <h3><i class="fas fa-bed"></i> Sleep & Rest</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="sleepDuration">Sleep Duration (hours)</label>
                                <input type="number" id="sleepDuration" name="Sleep_duration" min="1" max="12" step="0.5" required>
                            </div>
                            <div class="form-group">
                                <label>Sleep Quality (1-10)</label>
                                <div class="slider-container">
                                    <span>1</span>
                                    <input type="range" id="sleepQuality" name="Sleep_quality" class="slider" min="1" max="10" value="5">
                                    <span>10</span>
                                    <div class="slider-value" id="sleepQualityValue">5</div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Do you have a sleep disorder?</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="sleepDisorderY" name="Sleep_disorder" value="Y">
                                    <label for="sleepDisorderY">Yes</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="sleepDisorderN" name="Sleep_disorder" value="N" checked>
                                    <label for="sleepDisorderN">No</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Do you wake up during the night?</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="wakeUpY" name="Wake_up_during_night" value="Y">
                                    <label for="wakeUpY">Yes</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="wakeUpN" name="Wake_up_during_night" value="N" checked>
                                    <label for="wakeUpN">No</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Do you feel sleepy during the day?</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="sleepyDayY" name="Feel_sleepy_during_day" value="Y">
                                    <label for="sleepyDayY">Yes</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="sleepyDayN" name="Feel_sleepy_during_day" value="N" checked>
                                    <label for="sleepyDayN">No</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Health & Lifestyle -->
                    <div class="form-section">
                        <h3><i class="fas fa-heartbeat"></i> Health & Lifestyle</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Stress Level (1-10)</label>
                                <div class="slider-container">
                                    <span>1</span>
                                    <input type="range" id="stressLevel" name="Stress_level" class="slider" min="1" max="10" value="5">
                                    <span>10</span>
                                    <div class="slider-value" id="stressLevelValue">5</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="bloodPressure">Blood Pressure</label>
                                <input type="text" id="bloodPressure" name="Blood_pressure" placeholder="e.g., 120/80" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="heartRate">Heart Rate (BPM)</label>
                                <input type="number" id="heartRate" name="Heart_rate" min="40" max="200" required>
                            </div>
                            <div class="form-group">
                                <label for="dailySteps">Daily Steps</label>
                                <input type="number" id="dailySteps" name="Daily_steps" min="0" max="50000" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Physical Activity Level (1-10)</label>
                            <div class="slider-container">
                                <span>1</span>
                                <input type="range" id="physicalActivity" name="Physical_activity" class="slider" min="1" max="10" value="5">
                                <span>10</span>
                                <div class="slider-value" id="physicalActivityValue">5</div>
                            </div>
                        </div>
                    </div>

                    <!-- Substance Use -->
                    <div class="form-section">
                        <h3><i class="fas fa-coffee"></i> Substance Use</h3>
                        <div class="form-group">
                            <label>Do you consume caffeine?</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="caffeineY" name="Caffeine_consumption" value="Y">
                                    <label for="caffeineY">Yes</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="caffeineN" name="Caffeine_consumption" value="N" checked>
                                    <label for="caffeineN">No</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Do you consume alcohol?</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="alcoholY" name="Alcohol_consumption" value="Y">
                                    <label for="alcoholY">Yes</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="alcoholN" name="Alcohol_consumption" value="N" checked>
                                    <label for="alcoholN">No</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Do you smoke?</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="smokingY" name="Smoking" value="Y">
                                    <label for="smokingY">Yes</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="smokingN" name="Smoking" value="N" checked>
                                    <label for="smokingN">No</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Medical Information -->
                    <div class="form-section">
                        <h3><i class="fas fa-stethoscope"></i> Medical Information</h3>
                        <div class="form-group">
                            <label>Do you have any medical issues?</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="medicalIssueY" name="Medical_issue" value="Y">
                                    <label for="medicalIssueY">Yes</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="medicalIssueN" name="Medical_issue" value="N" checked>
                                    <label for="medicalIssueN">No</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Are you on ongoing medication?</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="medicationY" name="Ongoing_medication" value="Y">
                                    <label for="medicationY">Yes</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="medicationN" name="Ongoing_medication" value="N" checked>
                                    <label for="medicationN">No</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Digital Habits -->
                    <div class="form-section">
                        <h3><i class="fas fa-mobile-alt"></i> Digital Habits</h3>
                        <div class="form-group">
                            <label for="screenTime">Average Screen Time (hours/day)</label>
                            <input type="number" id="screenTime" name="Average_screen_time" min="0" max="24" step="0.5" required>
                        </div>
                        <div class="form-group">
                            <label>Do you use smart devices before bed?</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="deviceBeforeBedY" name="Smart_device_before_bed" value="Y">
                                    <label for="deviceBeforeBedY">Yes</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="deviceBeforeBedN" name="Smart_device_before_bed" value="N" checked>
                                    <label for="deviceBeforeBedN">No</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Do you use blue light filters?</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="blueLightY" name="Blue_light_filter" value="Y">
                                    <label for="blueLightY">Yes</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="blueLightN" name="Blue_light_filter" value="N" checked>
                                    <label for="blueLightN">No</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Eye Symptoms -->
                    <div class="form-section">
                        <h3><i class="fas fa-eye"></i> Current Eye Symptoms</h3>
                        <div class="form-group">
                            <label>Do you experience eye strain or discomfort?</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="eyeStrainY" name="Discomfort_eye_strain" value="Y">
                                    <label for="eyeStrainY">Yes</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="eyeStrainN" name="Discomfort_eye_strain" value="N" checked>
                                    <label for="eyeStrainN">No</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Do you have redness in your eyes?</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="rednessY" name="Redness_in_eye" value="Y">
                                    <label for="rednessY">Yes</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="rednessN" name="Redness_in_eye" value="N" checked>
                                    <label for="rednessN">No</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Do you experience itchiness or irritation in your eyes?</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="itchinessY" name="Itchiness_irritation_in_eye" value="Y">
                                    <label for="itchinessY">Yes</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="itchinessN" name="Itchiness_irritation_in_eye" value="N" checked>
                                    <label for="itchinessN">No</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="message" id="questionnaireMessage"></div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-chart-line"></i>
                            Complete Analysis
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Step 3: Comprehensive Results -->
        <div class="analysis-card results-section" id="resultsCard">
            <div class="card-header">
                <h3>Step 3: Comprehensive Analysis Results</h3>
                <p>Your complete eye health assessment based on image and questionnaire data</p>
            </div>

            <div class="card-content">
                <div class="result-summary" id="resultSummary">
                    <div class="risk-level" id="riskLevel">Analyzing...</div>
                    <p id="riskDescription">Please wait while we process your comprehensive analysis...</p>
                </div>

                <div class="analysis-grid">
                    <div class="analysis-item">
                        <h3><i class="fas fa-camera"></i> Image Analysis</h3>
                        <div id="imageAnalysisResult">
                            <p>Probability: <span id="imageProbability">-</span></p>
                            <div class="probability-bar">
                                <div class="probability-fill" id="imageBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-item">
                        <h3><i class="fas fa-clipboard-list"></i> Questionnaire Analysis</h3>
                        <div id="questionnaireAnalysisResult">
                            <p>Probability: <span id="questionnaireProbability">-</span></p>
                            <div class="probability-bar">
                                <div class="probability-fill" id="questionnaireBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="analysis-item">
                    <h3><i class="fas fa-chart-bar"></i> Combined Analysis</h3>
                    <div id="combinedAnalysisResult">
                        <p>Final Risk Score: <span id="finalRiskScore">-</span>/100</p>
                        <p>Confidence Level: <span id="confidenceLevel">-</span></p>
                        <div class="probability-bar">
                            <div class="probability-fill" id="combinedBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="analysis-item">
                    <h3><i class="fas fa-exclamation-triangle"></i> Risk Factors</h3>
                    <div class="risk-factors-grid" id="riskFactorsGrid">
                        <!-- Risk factors will be populated here -->
                    </div>
                </div>

                <div class="recommendations-section">
                    <div class="recommendations-header">
                        <h3><i class="fas fa-lightbulb"></i> Personalized Recommendations</h3>
                    </div>
                    <div class="recommendations-content" id="recommendationsContent">
                        <!-- Recommendations will be populated here -->
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <a href="/dashboard" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i>
                        Back to Dashboard
                    </a>
                    <button class="btn btn-secondary" onclick="showHistory()" style="margin-left: 15px;">
                        <i class="fas fa-history"></i>
                        View History
                    </button>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div class="analysis-card" id="historySection" style="display: none;">
            <div class="card-header">
                <h3>Analysis History</h3>
                <p>Your previous eye health assessments</p>
            </div>
            <div class="card-content" id="historyContent">
                <!-- History items will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentStep = 1;
        let imageAnalysisData = null;
        let questionnaireData = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            initializeSliders();
        });

        function setupEventListeners() {
            // File upload handling
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            
            fileInput.addEventListener('change', handleFileSelect);
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            uploadArea.addEventListener('dragleave', handleDragLeave);

            // Form submission
            document.getElementById('questionnaireForm').addEventListener('submit', handleQuestionnaireSubmit);
        }

        function initializeSliders() {
            const sliders = document.querySelectorAll('.slider');
            sliders.forEach(slider => {
                const valueDisplay = document.getElementById(slider.id + 'Value');
                slider.addEventListener('input', function() {
                    valueDisplay.textContent = this.value;
                });
            });
        }

        // Image upload functions
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                validateAndPreviewFile(file);
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                validateAndPreviewFile(files[0]);
            }
        }

        function handleDragLeave(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.remove('dragover');
        }

        function validateAndPreviewFile(file) {
            hideMessages();

            const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg'];
            if (!allowedTypes.includes(file.type)) {
                showMessage('error', 'Please upload a valid image file (PNG, JPG, JPEG)', 'imageMessage');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showMessage('error', 'File size must be less than 5MB', 'imageMessage');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('previewContainer').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function analyzeImage() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) {
                showMessage('error', 'Please select an image file first', 'imageMessage');
                return;
            }

            showLoading();
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<div class="loading-spinner"></div> Analyzing...';
            hideMessages();

            const formData = new FormData();
            formData.append('eye_image', file);

            fetch('/analyze-eye-image', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-search"></i> Analyze Image';

                if (data.success) {
                    // Store the complete image analysis data
                    imageAnalysisData = {
                        prediction: data.prediction,
                        confidence: data.confidence / 100, // Convert percentage to decimal
                        dry_eye_probability: data.prediction === 'Dry Eyes' ? 1.0 : 0.0,
                        is_valid_eye: data.is_valid_eye || true
                    };
                    
                    displayImageResult(data);
                    showMessage('success', 'Image analysis completed successfully!', 'imageMessage');
                } else {
                    imageAnalysisData = null;
                    showMessage('error', data.error || 'Analysis failed. Please try again.', 'imageMessage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                imageAnalysisData = null;
                hideLoading();
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-search"></i> Analyze Image';
                showMessage('error', 'Network error. Please check your connection and try again.', 'imageMessage');
            });
        }

        function displayImageResult(data) {
            const resultDiv = document.getElementById('imageResult');
            const resultText = document.getElementById('imageResultText');
            
            resultText.innerHTML = `
                <strong>Prediction:</strong> ${data.prediction}<br>
                <strong>Confidence:</strong> ${data.confidence}%<br>
                <strong>Status:</strong> ${data.message}
            `;
            
            resultDiv.style.display = 'block';
        }

        function proceedToQuestionnaire() {
            updateStep(2);
            document.getElementById('imageAnalysisCard').style.display = 'none';
            document.getElementById('questionnaireCard').style.display = 'block';
            
            // Scroll to questionnaire
            document.getElementById('questionnaireCard').scrollIntoView({ behavior: 'smooth' });
        }

        function handleQuestionnaireSubmit(e) {
            e.preventDefault();
            
            // Collect form data
            const formData = new FormData(e.target);
            const questionnaireData = {};
            
            for (let [key, value] of formData.entries()) {
                questionnaireData[key] = value;
            }

            // Add image analysis data if available
            if (imageAnalysisData && imageAnalysisData.is_valid_eye) {
                questionnaireData.image_analysis = {
                    dry_eye_probability: imageAnalysisData.dry_eye_probability,
                    confidence: imageAnalysisData.confidence,
                    prediction: imageAnalysisData.prediction
                };
            }

            submitQuestionnaire(questionnaireData);
        }

        function submitQuestionnaire(data) {
            showLoading();
            hideMessages();

            fetch('/submit-questionnaire', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                hideLoading();

                if (result.success) {
                    displayComprehensiveResults(result);
                    updateStep(3);
                    document.getElementById('questionnaireCard').style.display = 'none';
                    document.getElementById('resultsCard').style.display = 'block';
                    document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
                } else {
                    showMessage('error', result.error || 'Analysis failed. Please try again.', 'questionnaireMessage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                hideLoading();
                showMessage('error', 'Network error. Please check your connection and try again.', 'questionnaireMessage');
            });
        }

        function displayComprehensiveResults(data) {
            console.log('Displaying results:', data); // Debug log

            // Update risk level and description
            const riskLevel = document.getElementById('riskLevel');
            const riskDescription = document.getElementById('riskDescription');
            
            riskLevel.textContent = data.combined_analysis.risk_level;
            riskLevel.className = `risk-level ${data.combined_analysis.risk_level.toLowerCase().replace(' ', '-')}`;
            
            riskDescription.textContent = data.combined_analysis.has_dry_eyes ? 
                'Analysis indicates potential dry eye disease. Please review recommendations below.' :
                'Analysis shows low risk for dry eye disease. Continue healthy eye practices.';

            // Update individual analysis results
            if (data.individual_predictions.image_analysis) {
                const imageProb = data.individual_predictions.image_analysis.probability * 100;
                document.getElementById('imageProbability').textContent = `${imageProb.toFixed(1)}%`;
                updateProgressBar('imageBar', imageProb, imageProb);
                
                // Show that image was analyzed
                console.log('Image analysis available:', data.individual_predictions.image_analysis);
            } else {
                document.getElementById('imageProbability').textContent = 'Questionnaire only';
                updateProgressBar('imageBar', 0, 0);
                console.log('No image analysis data available');
            }

            const textProb = data.individual_predictions.text_analysis.probability * 100;
            document.getElementById('questionnaireProbability').textContent = `${textProb.toFixed(1)}%`;
            updateProgressBar('questionnaireBar', textProb, textProb);

            // Update combined analysis
            const combinedProb = data.combined_analysis.dry_eye_probability * 100;
            document.getElementById('finalRiskScore').textContent = data.combined_analysis.risk_score;
            document.getElementById('confidenceLevel').textContent = `${(data.combined_analysis.confidence * 100).toFixed(1)}%`;
            updateProgressBar('combinedBar', combinedProb, combinedProb);

            // Display risk factors
            displayRiskFactors(data.risk_factors);

            // Display recommendations
            displayRecommendations(data.recommendations);
        }

        function updateProgressBar(barId, percentage, value) {
            const bar = document.getElementById(barId);
            bar.style.width = `${percentage}%`;
            
            // Set color based on risk level
            if (value >= 70) {
                bar.className = 'probability-fill high';
            } else if (value >= 40) {
                bar.className = 'probability-fill medium';
            } else {
                bar.className = 'probability-fill low';
            }
        }

        function displayRiskFactors(riskFactors) {
            const grid = document.getElementById('riskFactorsGrid');
            grid.innerHTML = '';

            if (riskFactors.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #666;">No significant risk factors identified.</p>';
                return;
            }

            riskFactors.forEach(factor => {
                const factorDiv = document.createElement('div');
                factorDiv.className = `risk-factor-item ${factor.impact}`;
                factorDiv.innerHTML = `
                    <h5>${factor.factor}</h5>
                    <p>${factor.value}</p>
                    <small>Impact: ${factor.impact}</small>
                `;
                grid.appendChild(factorDiv);
            });
        }

        function displayRecommendations(recommendations) {
            const content = document.getElementById('recommendationsContent');
            content.innerHTML = '';

            const categories = [
                { key: 'immediate_actions', title: 'Immediate Actions', icon: 'fas fa-exclamation-circle' },
                { key: 'medical_advice', title: 'Medical Advice', icon: 'fas fa-user-md' },
                { key: 'lifestyle_changes', title: 'Lifestyle Changes', icon: 'fas fa-life-ring' },
                { key: 'monitoring', title: 'Ongoing Monitoring', icon: 'fas fa-chart-line' }
            ];

            categories.forEach(category => {
                if (recommendations[category.key] && recommendations[category.key].length > 0) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'recommendation-category';
                    
                    const categoryHtml = `
                        <h4><i class="${category.icon}"></i> ${category.title}</h4>
                        <ul class="recommendation-list">
                            ${recommendations[category.key].map((rec, index) => `
                                <li class="recommendation-item">
                                    <div class="recommendation-icon">
                                        <i class="fas fa-${getRecommendationIcon(category.key, index)}"></i>
                                    </div>
                                    <div>${rec}</div>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                    
                    categoryDiv.innerHTML = categoryHtml;
                    content.appendChild(categoryDiv);
                }
            });
        }

        function getRecommendationIcon(category, index) {
            const icons = {
                'immediate_actions': ['eye-dropper', 'compress', 'wind'],
                'medical_advice': ['stethoscope', 'calendar-check', 'prescription'],
                'lifestyle_changes': ['mobile-alt', 'moon', 'dumbbell'],
                'monitoring': ['chart-bar', 'clock', 'calendar']
            };
            
            return icons[category] ? icons[category][index % icons[category].length] : 'lightbulb';
        }

        function updateStep(step) {
            currentStep = step;
            
            // Update progress bar
            const progress = (step / 3) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            
            // Update step indicators
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.classList.remove('active', 'completed');
                
                if (i < step) {
                    stepEl.classList.add('completed');
                } else if (i === step) {
                    stepEl.classList.add('active');
                }
            }
        }

        function showHistory() {
            const historySection = document.getElementById('historySection');
            const historyContent = document.getElementById('historyContent');

            if (historySection.style.display === 'none') {
                historySection.style.display = 'block';
                loadHistory();
            } else {
                historySection.style.display = 'none';
            }
        }

        function loadHistory() {
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading-spinner" style="margin: 0 auto;"></div><p>Loading history...</p></div>';

            fetch('/eye-analysis-history')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.history.length > 0) {
                    historyContent.innerHTML = '';
                    data.history.forEach(item => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'analysis-item';
                        historyItem.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <strong>${item.prediction}</strong>
                                <span style="color: #666; font-size: 0.9rem;">${new Date(item.updated_date).toLocaleString()}</span>
                            </div>
                            <div>Risk Score: ${item.risk_score}/100</div>
                            <div style="margin-top: 10px;">
                                <small>Risk Factors: ${item.risk_factors.length} identified</small>
                            </div>
                        `;
                        historyContent.appendChild(historyItem);
                    });
                } else {
                    historyContent.innerHTML = '<p style="text-align: center; color: #666;">No analysis history found.</p>';
                }
            })
            .catch(error => {
                console.error('Error loading history:', error);
                historyContent.innerHTML = '<p style="text-align: center; color: #dc2626;">Failed to load history.</p>';
            });
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showMessage(type, message, containerId) {
            const messageEl = document.getElementById(containerId);
            messageEl.className = `message ${type}`;
            messageEl.textContent = message;
            messageEl.style.display = 'block';
        }

        function hideMessages() {
            const messages = document.querySelectorAll('.message');
            messages.forEach(msg => {
                msg.style.display = 'none';
            });
        }
    </script>
</body>
</html>